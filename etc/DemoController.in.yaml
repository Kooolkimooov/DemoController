---
# If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: true
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: false
# Where to look for state libraries
StatesLibraries:
  - "@BWC_STATES_LIBRARIES@"
  - "@MC_STATES_DEFAULT_INSTALL_PREFIX@"
  - "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
# Where to look for state files
StatesFiles:
  - "@BWC_STATES_FILES@"
  - "@MC_STATES_DEFAULT_INSTALL_PREFIX@/data"
  - "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data"
# If true, state factory will be more verbose
VerboseStateFactory: false
# General constraints, always on
constraints:
  - type: contact
  - type: kinematics
    damper: [ 0.1, 0.01, 0.5 ]
  - type: compoundJoint
# Collision constraint
collisions:
  - type: collision
    useMinimal: true

PostureTask:
  stiffness: 10

CoMTask:
  type: com
  stiffness: [ 1000.0, 1000.0, 1000.0 ]
  weight: 1000.0

BaseOrientationTask:
  type: orientation
  stiffness: 300.0
  weight: 500.0

FootTaskList:
  - type: firstOrderImpedance
    foot: Left
    frame: LeftFootCenter
    cutoffPeriod: 0.01
    weight: 1000.0
  - type: firstOrderImpedance
    foot: Right
    frame: RightFootCenter
    cutoffPeriod: 0.01
    weight: 1000.0

FootManager:
  name: FootManager
  footstepDuration: 0.9 # [sec]
  doubleSupportRatio: 0.15 # []
  deltaTransLimit: [ 0.15, 0.1, 7.5 ] # (x [m], y [m], theta [deg])
  midToFootTranss:
    Left:
      translation: [ 0, 0.11, 0 ] # [m]
    Right:
      translation: [ 0, -0.11, 0 ] # [m]
  footTaskGain:
    stiffness: 1000.0
  zmpHorizon: 2.0 # [sec]
  zmpOffset: [ 0, -0.02, 0 ] # (positive for x-forward, y-outside, z-upward) [m]
  defaultSwingTrajType: IndHorizontalVertical
  overwriteLandingPose: false
  stopSwingTrajForTouchDownFoot: true
  keepPoseForTouchDownFoot: false
  enableWrenchDistForTouchDownFoot: true
  enableArmSwing: false
  fricCoeff: 0.5
  touchDownRemainingDuration: 0.12 # [sec]
  touchDownPosError: 0.015 # [m]
  touchDownForceZ: 120 # [N]
  impedanceGains:
    SingleSupport:
      damper:
        linear: [ 300, 300, 300 ]
        angular: [ 100, 100, 100 ]
      spring:
        linear: [ 2250, 2250, 2250 ]
        angular: [ 0, 0, 2000 ]
      wrench:
        linear: [ 0, 0, 0 ]
        angular: [ 1, 1, 0 ]
    DoubleSupport:
      damper:
        linear: [ 300, 300, 1e4 ]
        angular: [ 100, 100, 100 ]
      spring:
        linear: [ 2250, 2250, 0 ]
        angular: [ 0, 0, 2000 ]
      wrench:
        linear: [ 0, 0, 1 ]
        angular: [ 1, 1, 0 ]
    Swing:
      damper:
        linear: [ 300, 300, 300 ]
        angular: [ 40, 40, 40 ]
      spring:
        linear: [ 2250, 2250, 2250 ]
        angular: [ 400, 400, 400 ]
      wrench:
        linear: [ 0, 0, 0 ]
        angular: [ 0, 0, 0 ]
  VelMode:
    footstepQueueSize: 3
    enableOnlineFootstepUpdate: true
  SwingTraj:
    CubicSplineSimple:
      withdrawDurationRatio: 0.25
      withdrawOffset: [ 0, 0, 0.015 ] # [m]
      approachDurationRatio: 0.25
      approachOffset: [ 0, 0, 0.015 ] # [m]
      swingOffset: [ 0, 0, 0.05 ] # [m]
    IndHorizontalVertical:
      withdrawDurationRatio: 0.25
      approachDurationRatio: 0.25
      verticalTopDurationRatio: 0.5
      verticalTopOffset: [ 0, 0, 0.05 ] # [m]
      tiltAngleWithdraw: 20 # [deg]
      tiltAngleApproach: 10 # [deg]
      tiltAngleWithdrawDurationRatio: 0.25
      tiltAngleApproachDurationRatio: 0.25
      tiltCenterWithdrawDurationRatio: 0.25
      tiltCenterApproachDurationRatio: 0.25
      tiltDistThre: 0.2 # [m]
      tiltForwardAngleThre: 10 # [deg]
    VariableTaskGain:
      withdrawDurationRatio: 0.25
      approachDurationRatio: 0.25
      verticalTopDurationRatio: 0.5
      verticalTopOffset: [ 0, 0, 0.05 ] # [m]
    LandingSearch:
      withdrawDurationRatio: 0.2
      withdrawOffset: [ 0, 0, 0.04 ] # [m]
      preApproachDurationRatio: 0.25
      approachDurationRatio: 0.2
      approachOffset: [ 0, 0, 0.04 ] # [m]

CentroidalManager:
  name: CentroidalManager
  useActualStateForMpc: false
  enableZmpFeedback: true
  enableComZFeedback: true
  dcmGainP: 2.0 # It must be greater than 1 to be stable
  zmpVelGain: 0.02
  comZGainP: 10000.0
  comZGainD: 500.0
  refComZ: 0.96 # [m]
  useTargetPoseForControlRobotAnchorFrame: true
  useActualComForWrenchDist: false
  actualComOffset: [ 0.0, 0.0, 0.0 ]
  wrenchDistConfig:
    wrenchWeight:
      linear: [ 1.0, 1.0, 1.0 ]
      angular: [ 1.0, 1.0, 1.0 ]
    regularWeight: 1e-8
    ridgeForceMinMax: [ 3, 1000 ] # [N]
  dcmEstimator:
    enableDcmEstimator: false
    dcmCorrectionMode: Bias # "Bias", "Filter", or "None"
    biasDriftPerSecondStd: 0.002
    dcmMeasureErrorStd: 0.01
    zmpMeasureErrorStd: 0.005
    biasLimit: [ 0.03, 0.03 ]
    initDcmUncertainty: [ 0.01, 0.01 ]
    initBiasUncertainty: [ 0.01, 0.01 ]

  # PreviewControlZmp
  method: PreviewControlZmp
  horizonDuration: 2.0 # [sec]
  horizonDt: 0.005 # [sec]
  reinitForRefComZ: true

# OverwriteConfigKeys: [NoSensors]

OverwriteConfigList:
  NoSensors:
    FootManager:
      impedanceGains:
        SingleSupport:
          damper:
            linear: [ 300, 300, 300 ]
            angular: [ 40, 40, 40 ]
          spring:
            linear: [ 2250, 2250, 2250 ]
            angular: [ 400, 400, 400 ]
          wrench:
            linear: [ 0, 0, 0 ]
            angular: [ 0, 0, 0 ]
        DoubleSupport:
          damper:
            linear: [ 300, 300, 300 ]
            angular: [ 40, 40, 40 ]
          spring:
            linear: [ 2250, 2250, 2250 ]
            angular: [ 400, 400, 400 ]
          wrench:
            linear: [ 0, 0, 0 ]
            angular: [ 0, 0, 0 ]
        Swing:
          damper:
            linear: [ 300, 300, 300 ]
            angular: [ 40, 40, 40 ]
          spring:
            linear: [ 2250, 2250, 2250 ]
            angular: [ 400, 400, 400 ]
          wrench:
            linear: [ 0, 0, 0 ]
            angular: [ 0, 0, 0 ]

    CentroidalManager:
      useActualStateForMpc: false
      enableZmpFeedback: false
      useActualComForWrenchDist: false

# Implement some additional text states
states:
  Initial:
    base: BWC::Initial
    configs:
      autoStartTime: 2.0

  Walk:
    base: BWC::FootstepPlanner
    configs:
      autoStart: true
      goalFootMidpose: [ 1.1, 0.3, 0.0 ] # [m], [rad]
      maxPlanningDuration: 1.0 # [sec]
      initialHeuristicsWeight: 10.0

      footstepPlanner:
        theta_divide_num: 64
        xy_divide_step: 0.01 # [m]

        cost_scale: 1.0e3
        cost_theta_scale: 0.0 # [m/rad]
        step_cost: 1.0

        heuristic_type: DijkstraPath
        dijkstra_path_heuristic_expand_scale: 5.0

        nominal_foot_separation: 0.2 # [m]

        r2l_action_cont_list: # [m], [rad]
          - [ 0.175, 0.0, 0.0 ]
          - [ -0.125, 0.0, 0.0 ]
          - [ 0.0, 0.125, 0.0 ]
          - [ 0.0, -0.05, 0.0 ]
          - [ 0.0, 0.0, 0.2618 ]
          - [ 0.0, 0.0, -0.2618 ]

        r2l_reachable_min: [ -0.1, 0.0, -0.1745 ] # [m], [rad]
        r2l_reachable_max: [ 0.1, 0.1, 0.1745 ] # [m], [rad]

# Transitions map
transitions:
  - [ Initial, OK, Walk, Auto ]

# Initial state
init: Initial

ObserverPipelines:
  name: MainObserverPipeline
  gui: true
  observers:
    - type: Encoder
    - type: Attitude
    - type: KinematicInertial
      config:
        anchorFrame:
          maxAnchorFrameDiscontinuity: 0.05 # [m]

robots:
  desk:
    module: env/2box_table
    init_pos:
      translation: [ 2.0, 0.0, 0.0 ]
      rotation: [ 0.0, 0.0, 1.57 ]
  # desk:
  #   module: env/table
  #   init_pos:
  #     translation: [ 2.0, 0.0, 0.0 ]
  #     rotation: [ 0.0, 0.0, 1.57 ]
  # zbox0:
  #   module: env/box
  #   init_pos:
  #     translation: [ 1.75, 0.3, 0.74 ]
  #     rotation: [ 0.0, 1.57, 0.0 ]
  # zbox1:
  #   module: env/box
  #   init_pos:
  #     translation: [ 1.75, -0.3, 0.74 ]
  #     rotation: [ 0.0, 1.57, 0.0 ]
  shelf0:
    module: env/table
    init_pos:
      translation: [ 0.6, 1.0, 0.0 ]
  shelf1:
    module: env/table
    init_pos:
      translation: [ 0.6, -1.35, 0.0 ]

  ground:
    module: env/ground

  rhps1:
    CoMTask:
      activeJoints: [
        "Root",
        "L_CROTCH_Y", "L_CROTCH_R", "L_CROTCH_P", "L_KNEE_P", "L_ANKLE_R", "L_ANKLE_P",
        "R_CROTCH_Y", "R_CROTCH_R", "R_CROTCH_P", "R_KNEE_P", "R_ANKLE_R", "R_ANKLE_P" ]

    BaseOrientationTask:
      frame: CHEST_P_LINK

  jvrc1:
    CoMTask:
      activeJoints: [
        "Root",
        "R_HIP_Y", "R_HIP_R", "R_HIP_P", "R_KNEE", "R_ANKLE_P", "R_ANKLE_R",
        "L_HIP_Y", "L_HIP_R", "L_HIP_P", "L_KNEE", "L_ANKLE_P", "L_ANKLE_R" ]

    BaseOrientationTask:
      frame: WAIST_R_S